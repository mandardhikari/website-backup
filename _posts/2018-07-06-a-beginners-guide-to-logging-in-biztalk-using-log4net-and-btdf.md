---
ID: 27
post_title: 'A Beginner&#8217;s Guide To Logging In BizTalk Using log4net and BTDF'
author: Mandar Dharmadhikari
post_excerpt: ""
layout: post
permalink: >
  https://theabodeofcode.com/a-beginners-guide-to-logging-in-biztalk-using-log4net-and-btdf/
published: true
post_date: 2018-07-06 06:41:44
---
<div dir="ltr" style="text-align:left;">
<h1>Introduction</h1>
Often is the requirement in software development that the developer trace the flow of the developed application to track any bugs or issues that are raised during the testing or production run. At other times the requirement can be that the developer want to track some mission critical data to files or to custom database for future use or simply they are required to audit the request responses processed by the application. The solution to that is using a good logging framework to track the data. One such well known logging framework is log4net which helps the developers to log well formatted events to various sinks like text files, databases etc.
<h2>What is log4net?</h2>
log4net is the MicroSoft .Net framework  port of the Apache log4j framework which is used as a logging utility for java applications. log4net allows developers to log the events to various targets like files, database stores etc.(see References section for the link to the documentation).
<h1>Scope</h1>
This article discusses the use of the log4net framework for the tracking of events in the BizTalk application. log4net can be used to track the steps of flow of the orchestration in the BizTalk application by using intelligent logging milestones in expression shapes which will let the developers know where the control is at a given point of time. These events can be logged to text file which can be tailed using any tailing application to view the logging in the real time. This serves as an addendum to the already present debugging feature like Orchestration Debugger. log4net can be used to save the messages processed by BizTalk orchestration to an audit database if that is the business requirement(not covered in current scope as it is not an ideal way to audit messages). The sample discussed in this article will use the BizTalk Deployment Framework to accommodate and automate the deployment of the log4net configuration components as a part of the deployment process.
<h1>What is BTDF?</h1>
BTDF is an open source deployment framework used for deploying BizTalk applications on local dev boxes as well
as different environments. It provides many facilities that can be used to club together the task that require to be performed pre and post deployment of the BizTalk deployment e.g restarting of the concerned Host Instances, IIS reset etc. Another advantage
of BTDF is that it is very flexible and can be configured to do a lot of tasks before, during and after the deployment of BizTalk application. All these tasks can be packaged up as a single msi file and can be installed on the target environment. It also provides
facility to define the variables related to different environments in a spreadsheet which simplifies the task of manually maintaining the binding files for the BizTalk application for Multiple environment. These are some of the features of BTDF. BTDF has proven
to be a very reliable tool for creating build msi for BizTalk. It is a necessary weapon in the arsenal of a professional working on BizTalk platform.

This article uses the latest version 5.7 that is released. To learn more about the installation of the btdf and step by step guide for configuring the BTDF, refer following link. The link discusses the steps taken for BizTalk 2016 and Visual Studio 2015 , but
same can be followed for other versions of BizTalk.

<a href="https://social.technet.microsoft.com/wiki/contents/articles/47821.step-by-step-guide-for-installation-and-configuration-of-btdf-for-biztalk-2016-and-visual-studio-2015.aspx" target="_blank" rel="noopener noreferrer">Step by Step Guide For Installation and Configuration of BTDF
for BizTalk 2016 and Visual Studio 2015</a>
<h1>Implementation</h1>
Following are various steps that are involved in setting up complete logging utility for a BizTalk application using log4net and BTDF.
<h2>Creating log4net  Configuration File</h2>
In order to define what sinks that will be used to log the details from the orchestrations/helper classes/ pipeline components, the first task is to create the configuration file for the log4net . In order to use it with the BTDF framework, the file is named as &lt;BizTalk ApplicationName&gt;.log4net and should be placed in the  visual studio solution folder for the same application. It can be included in the solution Items using the solution folder as shown in sample screen shot below.

<span style="white-space:pre;"> <a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/6724.Log4net1.JPG"><img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/6724.Log4net1.JPG" alt="" /></a> </span>

Following is a sample configuration file that is shown in the above screenshot. The comments in the config file explain the important concepts.
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">log4net</code> <code style="color:grey;">debug</code><code style="color:black;">=</code><code style="color:blue;">"true"</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">root</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">level</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"*"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">appender-ref</code> <code style="color:grey;">ref</code><code style="color:black;">=</code><code style="color:blue;">"EventLogAppender"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">root</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;!-- Logger which will call the Rolling File appender and Create the Log file</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">Minimum Logging Level is DEBUG--&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">logger</code> <code style="color:grey;">name</code><code style="color:black;">=</code><code style="color:blue;">"BTDFTestProject"</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">level</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"DEBUG"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">appender-ref</code> <code style="color:grey;">ref</code><code style="color:black;">=</code><code style="color:blue;">"RollingFileAppender"</code><code style="color:black;">/&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">logger</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;!--Rolling File Appender deined below will create a log file by Name BTDFTestLroject.log at the location configured in file</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">node. appendToFile allows to add multiple log entries to the same file. maximumFileSize governs the maximum size of log file after which</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">the appender will archive the current log file and create a new log file of same name--&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">appender</code> <code style="color:grey;">name</code><code style="color:black;">=</code><code style="color:blue;">"RollingFileAppender"</code> <code style="color:grey;">type</code><code style="color:black;">=</code><code style="color:blue;">"log4net.Appender.RollingFileAppender"</code> <code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">file</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"E:\logstore\BTDFTestProject.Log"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">appendToFile</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"true"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">DatePattern</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"dd-MM-yyyy"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">maxSizeRollBackups</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"10"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">maximumFileSize</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"1MB"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">staticLogFileName</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"true"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">layout</code> <code style="color:grey;">type</code><code style="color:black;">=</code><code style="color:blue;">"log4net.Layout.PatternLayout"</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>      </code><span style="margin-left:18px !important;"><code style="color:black;">&lt;!--Governs the pattern in which the data will be written. The OrchestrationInstanceiD helps to correlat the </code></span></div>
<div style="background-color:#f8f8f8;"><code>      </code><span style="margin-left:18px !important;"><code style="color:black;">messages in the DTA database--&gt;</code></span></div>
<div style="background-color:white;"><code>      </code><span style="margin-left:18px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">conversionPattern</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"%date [%thread] %-5level OrchestrationInstanceId: %property{InstanceId} %logger Message: %message%newline"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">layout</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">appender</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;!--Event Log Appender is used to log events to the windows event log. This appender can be used to create custom </code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">applkication logs if required.--&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">appender</code> <code style="color:grey;">name</code><code style="color:black;">=</code><code style="color:blue;">"EventLogAppender"</code> <code style="color:grey;">type</code><code style="color:black;">=</code><code style="color:blue;">"log4net.Appender.EventLogAppender"</code> <code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">layout</code> <code style="color:grey;">type</code><code style="color:black;">=</code><code style="color:blue;">"log4net.Layout.PatternLayout"</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>      </code><span style="margin-left:18px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">conversionPattern</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"%date [%thread] %-5level OrchestrationInstanceId: %property{InstanceId} %logger Message: %message%newline"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">layout</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;!--Defines that the logger will use the user under which the process is running</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">in BizTalk terms it is either the Host Instance associated with the orchestration or the Handler processing the ports(in case of custom pipelien components)--&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">secutrityContext</code> <code style="color:grey;">type</code><code style="color:black;">=</code><code style="color:blue;">"logh4net.Util.WindowsSecurityContext"</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>      </code><span style="margin-left:18px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">credentials</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"Process"</code><code style="color:black;">&gt;&lt;/</code><code style="color:#006699;font-weight:bold;">credentials</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">secutrityContext</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:#008200;">&lt;!--Defines that the minimum level for which the entry will be logged to eventy log is Error--&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">filter</code> <code style="color:grey;">type</code><code style="color:black;">=</code><code style="color:blue;">"log4net.Filter.LevelRangeFilter"</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>      </code><span style="margin-left:18px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">levelMin</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"ERROR"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>      </code><span style="margin-left:18px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">levelMax</code> <code style="color:grey;">value</code><code style="color:black;">=</code><code style="color:blue;">"FATAL"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">filter</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">appender</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">log4net</code><code style="color:black;">&gt;</code></span></div>
</div>
<h2>Configuring BTDF Project</h2>
In order to facilitate the deployment of the configuration file created above, it is necessary to configure the *.btdfproj file. Following are the settings that need to be done.
<h3>Including log4net during deployment</h3>
This can be done by adding following line in the PropertyGroup Defining the deployment conditions

<span style="font-size:12.1px;">.</span>
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">Includelog4net</code><code style="color:black;">&gt;True&lt;/</code><code style="color:#006699;font-weight:bold;">Includelog4net</code><code style="color:black;">&gt;</code></span></div>
</div>
<span style="font-size:12.1px;">
</span>
A typical Property Group defining the deployment conditions would look as follows.

<span style="font-size:12.1px;">
</span>
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">PropertyGroup</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">Configuration</code> <code style="color:grey;">Condition</code><code style="color:black;">=</code><code style="color:blue;">"'$(Configuration)' == ''"</code><code style="color:black;">&gt;Debug&lt;/</code><code style="color:#006699;font-weight:bold;">Configuration</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">Platform</code> <code style="color:grey;">Condition</code><code style="color:black;">=</code><code style="color:blue;">"'$(Platform)' == ''"</code><code style="color:black;">&gt;x86&lt;/</code><code style="color:#006699;font-weight:bold;">Platform</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">SchemaVersion</code><code style="color:black;">&gt;1.0&lt;/</code><code style="color:#006699;font-weight:bold;">SchemaVersion</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">ProjectName</code><code style="color:black;">&gt;BTDFTestProject&lt;/</code><code style="color:#006699;font-weight:bold;">ProjectName</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">ProjectVersion</code><code style="color:black;">&gt;1.0&lt;/</code><code style="color:#006699;font-weight:bold;">ProjectVersion</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">IncludeVirtualDirectories</code><code style="color:black;">&gt;True&lt;/</code><code style="color:#006699;font-weight:bold;">IncludeVirtualDirectories</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">UsingMasterBindings</code><code style="color:black;">&gt;True&lt;/</code><code style="color:#006699;font-weight:bold;">UsingMasterBindings</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">RequireXmlPreprocessDirectives</code><code style="color:black;">&gt;False&lt;/</code><code style="color:#006699;font-weight:bold;">RequireXmlPreprocessDirectives</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">ApplyXmlEscape</code><code style="color:black;">&gt;True&lt;/</code><code style="color:#006699;font-weight:bold;">ApplyXmlEscape</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">SkipIISReset</code><code style="color:black;">&gt;False&lt;/</code><code style="color:#006699;font-weight:bold;">SkipIISReset</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">Includelog4net</code><code style="color:black;">&gt;True&lt;/</code><code style="color:#006699;font-weight:bold;">Includelog4net</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">IncludeComponents</code><code style="color:black;">&gt;True&lt;/</code><code style="color:#006699;font-weight:bold;">IncludeComponents</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">PropertyGroup</code><code style="color:black;">&gt;</code></span></div>
</div>
<span style="font-size:12.1px;">
</span>
The BTDF installation process is a 32 bit process and when the btdf configures the log4net for the application, it creates the registry key in the Registry corresponding to the 32 bit process (SYSWOW64 32) but if the host instances processing the orchestration are 64 bit, then a registry key need to be created which corresponds to the 64 bit host instances. A custom post deployment target needs to be created for this task. It can be created as a sample shown below.

<span style="font-size:12.1px;">
</span>
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">Target</code> <code style="color:grey;">Name</code><code style="color:black;">=</code><code style="color:blue;">"CustomPostDeployTarget"</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">CallTarget</code> <code style="color:grey;">Targets</code><code style="color:black;">=</code><code style="color:blue;">"CreateLog4Net64BitRegKey"</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:white;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">Target</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">Target</code> <code style="color:grey;">Name</code><code style="color:black;">=</code><code style="color:blue;">"CreateLog4Net64BitRegKey"</code><code style="color:black;">&gt;</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">&lt;</code><code style="color:#006699;font-weight:bold;">Exec</code> <code style="color:grey;">Command</code><code style="color:black;">=</code><code style="color:blue;">""$(SystemRoot)\Sysnative\cscript.exe" /nologo "$(DeployTools)\WriteRegValue.vbs" $(Log4netRegKey) "@(Log4netFile)""</code> <code style="color:black;">/&gt;</code></span></div>
<div style="background-color:#f8f8f8;"><code>  </code><span style="margin-left:6px !important;"><code style="color:black;">&lt;/</code><code style="color:#006699;font-weight:bold;">Target</code><code style="color:black;">&gt;</code></span></div>
</div>
*Note: quotes used inside the <strong>Command=""</strong> need to be escaped using <strong>&amp;quot; </strong>

&nbsp;

<strong>
</strong>
The registry entries created by the BTDF in both the 32 bit and the 64 bit registry folders are shown below.

<span style="white-space:pre;"> <a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/5008.Log4net3.JPG"><img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/5008.Log4net3.JPG" alt="" /></a> </span>

Fig: BizTalk App Entry in 32 bit node
<span style="white-space:pre;"> <a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/2514.Log4net4.JPG"><img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/2514.Log4net4.JPG" alt="" /></a> </span>

Fig: BizTalk App Entry in 64 bit node

&nbsp;
<h2>Integrating log4net in Orchestration.</h2>
Following are the steps that need to be followed to integrate the log4net framework into an orchestration..
<ol>
	<li>Add the references to the log4net assemblies to the Orchestration Project as shown below.<span style="white-space:pre;"> <a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3173.Log4net5.JPG"><img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/3173.Log4net5.JPG" alt="" /></a> </span>&nbsp;</li>
	<li> Create the variables for the logger and for the logger properties collection as shown in sample screen shot below.<span style="white-space:pre;"> <a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/7282.Log4net6.JPG"><img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/7282.Log4net6.JPG" alt="" /></a> </span><span style="white-space:pre;"> <a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/5023.Log4net7.JPG"><img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/5023.Log4net7.JPG" alt="" /></a></span></li>
	<li>The variables created above can be initiated as shown below.
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">varLogger = log4net.Ext.Serializable.SLogManager.GetLogger(</code><code style="color:blue;">"BTDFTestProject"</code><code style="color:black;">, log4net.helpers.CallersTypeName.Name);</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:black;">varLogger.RegistryConfigurator();</code></span></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">varInstanceId = TestOrch(Microsoft.XLANGs.BaseTypes.InstanceId);</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:black;">varLogProperties.Set(</code><code style="color:blue;">"InstanceId"</code><code style="color:black;">, varInstanceId);</code></span></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">varLogger.Debug(varLogProperties,</code><code style="color:blue;">"Logger Initiated"</code><code style="color:black;">);</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:black;">varLogger.DebugFormat(varLogProperties, </code><code style="color:blue;">"Logger Logging {0} level using Format String for Instance Id {1}"</code><code style="color:black;">, </code><code style="color:blue;">"Debug"</code><code style="color:black;">, varInstanceId);</code></span></div>
</div></li>
	<li>The logger can be passed to the helper classes which are called from the orchestration. For example, method from following class is called from the TestOrch orchestration. The method just logs a sample string and then throws an Exception which can be caught in the TestOrch orchestration to demonstrate the event logging capability of log4net. The helper class is as follows.
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:#006699;font-weight:bold;">using</code> <code style="color:black;">System;</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:#006699;font-weight:bold;">using</code> <code style="color:black;">System.Collections.Generic;</code></span></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:#006699;font-weight:bold;">using</code> <code style="color:black;">System.Linq;</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:#006699;font-weight:bold;">using</code> <code style="color:black;">System.Text;</code></span></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:#006699;font-weight:bold;">using</code> <code style="color:black;">System.Threading.Tasks;</code></span></div>
<div style="background-color:#f8f8f8;"></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:#006699;font-weight:bold;">namespace</code> <code style="color:black;">BTDFTestProject.Components</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:black;">{</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:#006699;font-weight:bold;">public</code> <code style="color:#006699;font-weight:bold;">class</code> <code style="color:black;">OrchestrationHelper</code></span></div>
<div style="background-color:#f8f8f8;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">{</code></span></div>
<div style="background-color:white;"><code>        </code><span style="margin-left:24px !important;"><code style="color:#006699;font-weight:bold;">public</code> <code style="color:#006699;font-weight:bold;">static</code> <code style="color:#006699;font-weight:bold;">void</code> <code style="color:black;">InvokeException(log4net.ILog logger, </code><code style="color:#006699;font-weight:bold;">string</code> <code style="color:black;">instanceId)</code></span></div>
<div style="background-color:#f8f8f8;"><code>        </code><span style="margin-left:24px !important;"><code style="color:black;">{</code></span></div>
<div style="background-color:white;"></div>
<div style="background-color:#f8f8f8;"><code>            </code><span style="margin-left:36px !important;"><code style="color:black;">logger.Info(</code><code style="color:blue;">"This Call is Initiated from the Helper Class Library for Instance Id " + </code><code style="color:black;">instanceId);</code></span></div>
<div style="background-color:white;"><code>            </code><span style="margin-left:36px !important;"> </span></div>
<div style="background-color:#f8f8f8;"><code>            </code><span style="margin-left:36px !important;"><code style="color:#006699;font-weight:bold;">throw</code> <code style="color:#006699;font-weight:bold;">new</code> <code style="color:black;">System.Exception("Throwing Exception from the helper to show event logging ability of log4net") ;</code></span></div>
<div style="background-color:white;"><code>                </code><span style="font-size:12.1px;"> </span></div>
<div style="background-color:#f8f8f8;"><code>        </code><span style="margin-left:24px !important;"><code style="color:black;">}</code></span></div>
<div style="background-color:white;"><code>    </code><span style="margin-left:12px !important;"><code style="color:black;">}</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:black;">}</code></span></div>
</div>
The call made to InvokeException function from the orchestration is as follows.
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">varLogger.Info(varLogProperties, </code><code style="color:blue;">"Finished Executing Map"</code><code style="color:black;">);</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:black;">varLogger.InfoFormat(varLogProperties, </code><code style="color:blue;">"Sending Response for Instance Id : {0}"</code><code style="color:black;">, varInstanceId);</code></span></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">BTDFTestProject.Components.OrchestrationHelper.InvokeException(varLogger,varInstanceId);</code></span></div>
</div></li>
	<li>The Logging placed in the exception block of the TestOrch is as follows.
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:black;">varLogger.Error(varLogProperties,</code><code style="color:blue;">"Exception Thrown. Error:"</code> <code style="color:black;">+ ex.Message);</code></span></div>
</div></li>
</ol>
This completes the set up of the logger with the application.
<h1>Testing</h1>
The orchestration was triggered using the BizTalk WCF Service and following are the observations.

log4net config File was Deployed at the location specified while installing the BTDF msi.

<span style="white-space:pre;"> <a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/3858.Log4net8.JPG"><img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/3858.Log4net8.JPG" alt="" /></a> </span>

Following log was created at the location specified in the log4net file.

<span style="white-space:pre;"> <a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/4377.LogFileCreated.JPG"><img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/4377.LogFileCreated.JPG" alt="" /></a> </span>
The events logged in the log file are as follows.
<div class="reCodeBlock" style="border:1px solid #7f9db9;overflow-y:auto;">
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:#009900;">2018</code><code style="color:#009900;">-02</code><code style="color:#009900;">-17</code> <code style="color:#009900;">03:</code><code style="color:#009900;">49:</code><code style="color:#009900;">09</code><code style="color:black;">,</code><code style="color:#009900;">673</code> <code style="color:black;">[</code><code style="color:#009900;">65</code><code style="color:black;">] DEBUG OrchestrationInstanceId: </code><code style="color:#009900;">05</code><code style="color:black;">d</code><code style="color:#009900;">3</code><code style="color:black;">e</code><code style="color:#009900;">6</code><code style="color:black;">f</code><code style="color:#009900;">3</code><code style="color:black;">-ffe</code><code style="color:#009900;">5</code><code style="color:#009900;">-4</code><code style="color:black;">ef</code><code style="color:#009900;">1</code><code style="color:black;">-be</code><code style="color:#009900;">11</code><code style="color:#009900;">-7</code><code style="color:black;">fce</code><code style="color:#009900;">83089</code><code style="color:black;">fd</code><code style="color:#009900;">2</code> <code style="color:black;">BTDFTestProject.Orchestration.TestOrch Message: Logger Initiated</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:#009900;">2018</code><code style="color:#009900;">-02</code><code style="color:#009900;">-17</code> <code style="color:#009900;">03:</code><code style="color:#009900;">49:</code><code style="color:#009900;">09</code><code style="color:black;">,</code><code style="color:#009900;">825</code> <code style="color:black;">[</code><code style="color:#009900;">65</code><code style="color:black;">] DEBUG OrchestrationInstanceId: </code><code style="color:#009900;">05</code><code style="color:black;">d</code><code style="color:#009900;">3</code><code style="color:black;">e</code><code style="color:#009900;">6</code><code style="color:black;">f</code><code style="color:#009900;">3</code><code style="color:black;">-ffe</code><code style="color:#009900;">5</code><code style="color:#009900;">-4</code><code style="color:black;">ef</code><code style="color:#009900;">1</code><code style="color:black;">-be</code><code style="color:#009900;">11</code><code style="color:#009900;">-7</code><code style="color:black;">fce</code><code style="color:#009900;">83089</code><code style="color:black;">fd</code><code style="color:#009900;">2</code> <code style="color:black;">BTDFTestProject.Orchestration.TestOrch Message: Logger Logging Debug </code><code style="color:#009900;">level</code> <code style="color:black;">using Format String for Instance Id </code><code style="color:#009900;">05</code><code style="color:black;">d</code><code style="color:#009900;">3</code><code style="color:black;">e</code><code style="color:#009900;">6</code><code style="color:black;">f</code><code style="color:#009900;">3</code><code style="color:black;">-ffe</code><code style="color:#009900;">5</code><code style="color:#009900;">-4</code><code style="color:black;">ef</code><code style="color:#009900;">1</code><code style="color:black;">-be</code><code style="color:#009900;">11</code><code style="color:#009900;">-7</code><code style="color:black;">fce</code><code style="color:#009900;">83089</code><code style="color:black;">fd</code><code style="color:#009900;">2</code></span></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:#009900;">2018</code><code style="color:#009900;">-02</code><code style="color:#009900;">-17</code> <code style="color:#009900;">03:</code><code style="color:#009900;">49:</code><code style="color:#009900;">18</code><code style="color:black;">,</code><code style="color:#009900;">693</code> <code style="color:black;">[</code><code style="color:#009900;">65</code><code style="color:black;">] INFO  OrchestrationInstanceId: </code><code style="color:#009900;">05</code><code style="color:black;">d</code><code style="color:#009900;">3</code><code style="color:black;">e</code><code style="color:#009900;">6</code><code style="color:black;">f</code><code style="color:#009900;">3</code><code style="color:black;">-ffe</code><code style="color:#009900;">5</code><code style="color:#009900;">-4</code><code style="color:black;">ef</code><code style="color:#009900;">1</code><code style="color:black;">-be</code><code style="color:#009900;">11</code><code style="color:#009900;">-7</code><code style="color:black;">fce</code><code style="color:#009900;">83089</code><code style="color:black;">fd</code><code style="color:#009900;">2</code> <code style="color:black;">BTDFTestProject.Orchestration.TestOrch Message: Finished Executing Map</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:#009900;">2018</code><code style="color:#009900;">-02</code><code style="color:#009900;">-17</code> <code style="color:#009900;">03:</code><code style="color:#009900;">49:</code><code style="color:#009900;">18</code><code style="color:black;">,</code><code style="color:#009900;">695</code> <code style="color:black;">[</code><code style="color:#009900;">65</code><code style="color:black;">] INFO  OrchestrationInstanceId: </code><code style="color:#009900;">05</code><code style="color:black;">d</code><code style="color:#009900;">3</code><code style="color:black;">e</code><code style="color:#009900;">6</code><code style="color:black;">f</code><code style="color:#009900;">3</code><code style="color:black;">-ffe</code><code style="color:#009900;">5</code><code style="color:#009900;">-4</code><code style="color:black;">ef</code><code style="color:#009900;">1</code><code style="color:black;">-be</code><code style="color:#009900;">11</code><code style="color:#009900;">-7</code><code style="color:black;">fce</code><code style="color:#009900;">83089</code><code style="color:black;">fd</code><code style="color:#009900;">2</code> <code style="color:black;">BTDFTestProject.Orchestration.TestOrch Message: Sending Response for Instance Id : </code><code style="color:#009900;">05</code><code style="color:black;">d</code><code style="color:#009900;">3</code><code style="color:black;">e</code><code style="color:#009900;">6</code><code style="color:black;">f</code><code style="color:#009900;">3</code><code style="color:black;">-ffe</code><code style="color:#009900;">5</code><code style="color:#009900;">-4</code><code style="color:black;">ef</code><code style="color:#009900;">1</code><code style="color:black;">-be</code><code style="color:#009900;">11</code><code style="color:#009900;">-7</code><code style="color:black;">fce</code><code style="color:#009900;">83089</code><code style="color:black;">fd</code><code style="color:#009900;">2</code></span></div>
<div style="background-color:white;"><span style="margin-left:0 !important;"><code style="color:#009900;">2018</code><code style="color:#009900;">-02</code><code style="color:#009900;">-17</code> <code style="color:#009900;">03:</code><code style="color:#009900;">49:</code><code style="color:#009900;">18</code><code style="color:black;">,</code><code style="color:#009900;">706</code> <code style="color:black;">[</code><code style="color:#009900;">65</code><code style="color:black;">] INFO  OrchestrationInstanceId: (null) BTDFTestProject.Orchestration.TestOrch Message: This Call is Initiated from the Helper Class Library for Instance Id </code><code style="color:#009900;">05</code><code style="color:black;">d</code><code style="color:#009900;">3</code><code style="color:black;">e</code><code style="color:#009900;">6</code><code style="color:black;">f</code><code style="color:#009900;">3</code><code style="color:black;">-ffe</code><code style="color:#009900;">5</code><code style="color:#009900;">-4</code><code style="color:black;">ef</code><code style="color:#009900;">1</code><code style="color:black;">-be</code><code style="color:#009900;">11</code><code style="color:#009900;">-7</code><code style="color:black;">fce</code><code style="color:#009900;">83089</code><code style="color:black;">fd</code><code style="color:#009900;">2</code></span></div>
<div style="background-color:#f8f8f8;"><span style="margin-left:0 !important;"><code style="color:#009900;">2018</code><code style="color:#009900;">-02</code><code style="color:#009900;">-17</code> <code style="color:#009900;">03:</code><code style="color:#009900;">49:</code><code style="color:#009900;">18</code><code style="color:black;">,</code><code style="color:#009900;">773</code> <code style="color:black;">[</code><code style="color:#009900;">65</code><code style="color:black;">] ERROR OrchestrationInstanceId: </code><code style="color:#009900;">05</code><code style="color:black;">d</code><code style="color:#009900;">3</code><code style="color:black;">e</code><code style="color:#009900;">6</code><code style="color:black;">f</code><code style="color:#009900;">3</code><code style="color:black;">-ffe</code><code style="color:#009900;">5</code><code style="color:#009900;">-4</code><code style="color:black;">ef</code><code style="color:#009900;">1</code><code style="color:black;">-be</code><code style="color:#009900;">11</code><code style="color:#009900;">-7</code><code style="color:black;">fce</code><code style="color:#009900;">83089</code><code style="color:black;">fd</code><code style="color:#009900;">2</code> <code style="color:black;">BTDFTestProject.Orchestration.TestOrch Message: Exception Thrown. Error:Throwing Exception from the helper to demonstarte event logging capability of log</code><code style="color:#009900;">4</code><code style="color:black;">net</code></span></div>
</div>
At the same time the following is a screenshot for the error logged in the event log.

<span style="white-space:pre;"><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/communityserver-wikis-components-files/00-00-00-00-05/2727.eventlog.JPG"> <img style="border-style:solid;border-width:0;" src="https://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/communityserver-wikis-components-files/00-00-00-00-05/5684.eventlog.JPG" alt="" /> </a> </span>
<h1><span style="white-space:pre;">Conclusion</span></h1>
From the results of the testing, it can be concluded that the logging for events in BizTalk artefacts like orchestrations , helper classes can be set up easily using the log4net framework and BTDF very easily.
<h1>References</h1>
Information available at following websites was referred while writing this article.
<ol>
	<li><a href="https://logging.apache.org/log4net/" target="_blank" rel="noopener noreferrer">What is Apache log4net</a></li>
	<li><a href="http://www.tfabraham.com/BTDFDocs/V5_0/DeploymentFrameworkForBizTalkDocs.html" target="_blank" rel="noopener noreferrer">Deployment Framework for BizTalk Server V5.0</a></li>
</ol>
&nbsp;

&nbsp;

&nbsp;

&nbsp;

</div>
&nbsp;